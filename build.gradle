defaultTasks 'minifyJs','archive','finish'

buildscript {
   repositories {
	   mavenLocal()
       mavenCentral()
   }
   dependencies {
		classpath 'com.eriwen:gradle-js-plugin:0.1'
   }
}

apply plugin: 'js'

def srcFile = "${projectDir}/src/index.js"
def buildNumber = System.getenv().BUILD_NUMBER
def version = "2.1.0"
def gitBranch = System.getenv().GIT_BRANCH
if(gitBranch){
	gitBranch = gitBranch.replaceAll("origin/","")
}

minifyJs {
   	input = file(srcFile)
   	output = file("$buildDir/${version}.js")
}

task feature(type: Copy) { 
  mkdir("${buildDir}/${gitBranch}")
  from "$projectDir/src/index.js" 
  into "$buildDir/${gitBranch}/"
  rename "index.js", "${version}-${buildNumber}.js"
}

combineJs {
  mkdir("${buildDir}/auto")
  file1 = fileTree(dir: "${projectDir}/src", includes: ['index.js'])
  file2 = fileTree(dir: "${projectDir}/src", includes: ['auto-create-players.js'])
  inputs.files file1 + file2
  outputs.file file("${buildDir}/auto/${version}.js")
}

task archive(type: Copy) { 
  mkdir("${buildDir}/archive")
  from "$projectDir/src/index.js" 
  into "$buildDir/archive/"
  rename "index.js", "${version}-${buildNumber}.js"
}

task finish(type: Copy) { 
  mkdir("${buildDir}/detailed")
  from "$projectDir/src/index.js" 
  into "$buildDir/detailed/"
  rename "index.js", "${version}.js"
}
