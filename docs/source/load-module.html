<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">(function(MTVNPlayer, yepnope) {
    var _ = MTVNPlayer.require(&quot;_&quot;),
        ModuleLoader = MTVNPlayer.module(&quot;ModuleLoader&quot;),
        isIE = /ms(ie)\s((\d+)?[\w\.]+)/i.test(navigator.userAgent),
        jQuery = &quot;http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js&quot;,
        Zepto = &quot;http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js&quot;,
        // this is used right now to see if we need can use Zepto instead of jQuery.
        dependencyMap = {
            &quot;$&quot;: isIE ? jQuery : Zepto
        },
        versionIsMinimum = MTVNPlayer.module(&quot;config&quot;).versionIsMinimum,
        provideJQuery = function() {
            // provide $ if it's on the window
            if(!MTVNPlayer.has(&quot;$&quot;)) {
                var $ = window.jQuery;
                // TODO we can lower this version if we want to test first.
                if($ &amp;&amp; versionIsMinimum(&quot;1.9.0&quot;, $.fn.jquery)) {
                    MTVNPlayer.provide(&quot;$&quot;, $);
                }
                $ = window.Zepto;
                // Zepto doesn't have a version number so we're winging it.
                if($) {
                    MTVNPlayer.provide(&quot;$&quot;, $);
                }
            }
        },
        executeCallbacks = function(callbacks) {
            while(callbacks.length &gt; 0) {
                callbacks.shift()();
            }
        },
        EndSlateModule = {
            callbacks: [],
            eventName: &quot;endSlate&quot;,
            loadModule: _.once(function(module) {
                // store the current $.
                var $ = window.$;
                // build the paths
                // we want to be able to override this for testing w/o updating the confi
                var js = this.js || module.url,
                    css = this.css || module.css;
                provideJQuery();
                // we removed yepnope from the window,
                // and yepnope tries to reference window.yepnope in its own function (unfortunately)
                // so we make a dummy object providing that reference.
                yepnope.call({
                    yepnope: yepnope
                }, {
                    load: ModuleLoader.getDependencyList(module.dependencies).concat([js, css]),
                    callback: function() {
                        provideJQuery();
                    },
                    complete: function() {
                        // reset the window $ to what it was before loading.
                        window.$ = $;
                        executeCallbacks(EndSlateModule.callbacks);
                    }
                });
            }),
            onModuleRequested: function(event) {
                var player = event.target;
                // add callback
                this.callbacks.push(function() {
                    new(MTVNPlayer.require(&quot;endslate&quot;))({
                        config: event.data,
                        player: player
                    });
                });
                if(MTVNPlayer.has(&quot;endslate&quot;)) {
                    executeCallbacks(this.callbacks);
                } else {
                    this.loadModule(player.config.module.endslate);
                }
            }
        };
    // bind
    _.bindAll(EndSlateModule);
<span id='global-method-getDependencyList'>    /**
</span>     * @ignore
     * builds an array of urls for dependencies that aren't loaded.
     */
    ModuleLoader.getDependencyList = function(dependencies) {
        var load = [];
        _(dependencies).each(function(value, id) {
            // check if the dependency is loaded.
            if(!MTVNPlayer.has(id)) {
                load.push(dependencyMap[id] || value.url);
            }
        });
        return load;
    };
    // Exports
    ModuleLoader.isIE = isIE;
    ModuleLoader.Events = {
        END_SLATE: EndSlateModule.eventName
    };
    // Export module configs so they can be adjusted for testing.
    ModuleLoader.EndSlateModule = EndSlateModule;
<span id='global-property-'>    /**
</span>     * @ignore
     * When any player is created, listen for an end slate event
     */
    MTVNPlayer.onPlayer(function(player) {
        player.bind(EndSlateModule.eventName, EndSlateModule.onModuleRequested);
    });
})(window.MTVNPlayer, window.yepnope);</pre>
</body>
</html>
